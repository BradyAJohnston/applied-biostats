---
title: "Models for two (or more) categorical X variables -- Factorial designs"
author: "Jeffrey A. Walker"
date: "11/13/2020"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_caption: yes
    number_sections: true
    code_folding: show
    includes:
      before_body: copyright.html
---
# Models for two (or more) categorical $X$ -- Factorial designs

```{r factorial-setup, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(janitor)
library(readxl)
library(data.table)
library(stringr)
library(dplyr)

# analysis packages
library(nlme) # gls
library(lmerTest) # lmm
library(emmeans)
library(car) # qqplot, spreadlevel
library(lmPerm)

# graphing packages
library(ggplot2) # ggplot environment
library(ggpubr) # publication ready plots
library(ggforce) # jitter
library(ggsci) # color palettes
library(ggpubfigs) # color palettes
library(ggthemes) # themes and palettes including colorblind
# execute this command only the first time you use ggpubfigs
# devtools::install_github("JLSteenwyk/ggpubfigs")
library(cowplot) # combine plots
library(lazyWeave) # pretty pvalues
library(broom)
library(kableExtra) #tables


here <- here::here
data_folder <- "data"

# Okabe & Ito palette
pal_ito_seven <- friendly_pal("ito_seven") # ggpubfigs
pal_okabe_ito <- colorblind_pal()(8)[2:8] # ggthemes

```

## Factorial experiments 
A factorial experiment is one in which there are two or more factor variables (categorical $X$) that are **crossed**, resulting in a group for each combination of the levels of each factor. Factorial experiments are used to estimate the **interaction** effect between factors. Interaction effects were introduced in Chapter xxx, Models with a added covariate. Remember the key to interactions -- two factors interact when the effect of one factor depends on the level of the other factor. Interactions are ubiquitous, although sometimes they are small enough to ignore with little to no loss of understanding.

## Example 1: Maize defense response

This chapter uses data from an experiment measuring the effect of two defense signals on the defense response in Maize plants. In response to herbivory from insects, maize, and other plants, release multiple, chemical signals into the air (chemicals that evaporate into the air are known as volatile compounds). These chemicals signal the plant, and neighboring plants, to secrete anti-herbivory hormones, including abcisic acid and jasmonic acid. The researchers investigated the effects of two volatile compounts, (Z)‐3‐hexenyl acetate (HAC) and Indole, on the defense response both each without the other and in combination.

The example data come from Figure 1a, which is the effect of HAC and Indole on tissue concentrations of the hormone abcisic acid (ABA). The design is fully crossed with two factors, each with two levels: $hac$, with levels "HAC-" and "HAC+", and $indole$, with levels ("Indole-" and "Indole+").  A good way to visualize the treatment combinations in a crossed design is with a $m \times p$ table showing all combinations of the $m$ levels of factor 1 ($hac$) against the $p$ levels of factor 2 ($indole$).

```{r factorial-2way-table, echo = FALSE, message=FALSE, warning=FALSE}
df <- data.frame("HAC-" = c("Control", "Indole"),
                 "HAC+" = c("HAC", "HAC+Indole"))
row.names(df) <- c("Indole-", "Indole+")
knitr::kable(df, col.names = c("HAC-", "HAC+"))
```

```{r factorial-import-ecology, echo=FALSE, warning=FALSE, message=FALSE}

data_from <- "Integration of two herbivore-induced plant volatiles results in synergistic effects on plant defense and resistance"
file_name <- "Data for Dryad.xlsx"
file_path <- here(data_folder, data_from, file_name)

fig1 <- read_excel(file_path,
                     sheet = "Fig. 1",
                     range = "A3:K23", # 1 blank column
                     col_names = TRUE) %>%
  data.table() %>%
  clean_names()

fig1[treat == "Control", c("hac", "indole") := list("HAC-", "Indole-")]
fig1[treat == "HAC", c("hac", "indole") := list("HAC+", "Indole-")]
fig1[treat == "Indole", c("hac", "indole") := list("HAC-", "Indole+")]
fig1[treat == "HAC+Indole", c("hac", "indole") := list("HAC+", "Indole+")]

treat_levels <- c("Control", "HAC", "Indole", "HAC+Indole")
fig1[, treat := factor(treat, levels = treat_levels)]
fig1[, hac := factor(hac)] # levels in correct order
fig1[, indole := factor(indole)] # levels in correct order
# View(fig1)
```
### Analysis

#### Examine the data

```{r}
qplot(x = treat, y = aba, data = fig1)
```

Too few points for box plot. control variance is small. No obvious implausible points. fit with lm but recognize small n warning for any inference.

#### Fit the model
```{r factorial-fit-model}
m1 <- lm(aba ~ hac * indole, data = fig1)
```

#### Model check

```{r}
qqPlot(m1, id = FALSE)
```

A plausible sample from a Normal distribution.

```{r}
spreadLevelPlot(m1)
```
A bit of increase in variance with mean. 

#### Inference from the model

```{r}
m1_coef <- cbind(coef(summary(m1)),
                 confint(m1))
knitr::kable(m1_coef, digits = 3)
```


```{r}
m1_emm <- emmeans(m1, specs = c("hac", "indole"))
knitr::kable(m1_emm, digits = 2)
```

```{r}
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise",
                     simple = "each",
                     combine = TRUE,
                     adjust = "none") %>%
  summary(infer = TRUE)

knitr::kable(m1_pairs, digits = 2)
```

#### Plot the model

xxx if interested in synergy plot the coefficients! this is what we want. When would we want to plot all simple effects?

```{r factorial-aba-prepare-plot, echo=FALSE}

m1_emm_dt <- summary(m1_emm) %>%
  data.table
m1_emm_dt[, treat := levels(fig1$treat)]
m1_pairs_dt <- data.table(m1_pairs)

# create contrast column with unique value each row
within_group <- c("Indole-", "Indole+", "HAC-", "HAC+")
m1_pairs_dt[, contrast := paste(within_group, contrast, sep =": ")]

# add interaction row
m1_pairs_dt <- rbind(m1_pairs_dt,
                     data.table(contrast = "Interaction",
                                estimate = m1_coef[4, "Estimate"],
                                lower.CL = m1_coef[4, "2.5 %"],
                                upper.CL = m1_coef[4, "97.5 %"],
                                p.value = m1_coef[4, "Pr(>|t|)"]),
                     fill = TRUE)

# pvalString is from package lazyWeave
m1_pairs_dt[ , p_pretty := pvalString(p.value)]
# also create a column with "p-val: "
m1_pairs_dt[ , pval_pretty := paste("p-val:", p_pretty)]
```


```{r factorial-aba-build-plot, echo=FALSE}
# response plot using treat column
gg_response <- ggplot(data = fig1,
                            aes(x = aba,
                                y = treat,
                                color = hac,
                                shape = indole)) +
  # points
  geom_jitter(alpha = 0.5,
            height = 0.4) +
  
  # plot means and CI
  geom_errorbar(data = m1_emm_dt,
                aes(x = emmean,
                    xmin = lower.CL,
                    xmax = upper.CL,
                    color = hac),
                width = 0,
  ) +
  
  geom_point(data = m1_emm_dt,
             aes(x = emmean,
                 color = hac),
             size = 3
  ) +

  # aesthetics
  xlab("ABA (ng per g FW)") +
  scale_color_manual(values=pal_okabe_ito,
                     name = NULL) +
  theme_pubr() +
  theme(legend.position="none") +
  theme(axis.title.y=element_blank()) +
  
  NULL

# gg_effect

contrast_order <- m1_pairs_dt[, contrast]
m1_pairs_dt[, contrast := factor(contrast, contrast_order)]
contrast_labels <- c("HAC - Control",
                     "HAC+Indole - Indole",
                     "Indole - Control",
                     "HAC+Indole - HAC",
                     "Interaction")

gg_effect <- ggplot(data = m1_pairs_dt, 
                    aes(x = estimate,
                        y = contrast)) +
  # confidence level of effect
  geom_errorbar(aes(xmin=lower.CL, 
                    xmax=upper.CL),
                width=0, 
                color="black") +
  # estimate of effect
  geom_point(size = 3) +
  
  # draw a line at effect = 0
  geom_vline(xintercept=0, linetype = 2) +
  # draw a line to sep interaction from simple effects
  geom_vline(xintercept=4.5, color = "gray") +
  
  # p-value. The y coordinates are set by eye
  annotate(geom = "text",
           label = m1_pairs_dt$p_pretty,
           y = 1:5,
           x = 40,
           size = 3) +
  
  # aesthetics
  
  scale_y_discrete(labels = contrast_labels) +
  scale_x_continuous(position = "top") + # move to top

  xlab("Effect (ng per g FW)") +
  ylab("Contrast") +
  coord_cartesian(xlim = c(-10,40)) +
  
  # use ggpubr theme
  theme_pubr() +
  theme(axis.title.y=element_blank()) +
  
  NULL

#gg_effect
```

```{r factorial-aba-plot, echo=FALSE}
plot_grid(gg_effect,
          gg_response,
          nrow=2,
          align = "v",
          axis = "lr",
          rel_heights = c(0.5,1))
```

### A factorial model adds an interaction effect to the coefficients table

A factorial design allows a researcher to estimate the interaction between two factors. An interaction is an effect between two variables in a linear model. The interaction effect is the coefficient $beta_3$ in the linear model

\begin{equation}
aba = \beta_0 + \beta_1 hac_{HAC^+} + \beta_2 indole_{Indole^+} + \beta_3 hac_{HAC^+}:indole_{Indole^+} +\varepsilon
(\#eq:factorial-full)
\end{equation}

$hac_{HAC^+}$ and $indole_{Indole^+}$ are dummy-coded **indicator variables** indicating group membership. $hac_{HAC^+} : indole_{Indole^+}$ is a dummy-coded variable for the interaction between $hac$ and $indole$. The value of this variable is the product of the two indicator variables in the interaction ($hac_{HAC^+}$ and $indole_{Indole^+}$), which can be verified with the model matrix (which here, is computed from the subset of the data that includeds only the first two rows of each treatment combination)

```{r factorial-dummy, echo=FALSE}
m1_mm <- model.matrix(m1)
first_two <- c(1:2, 6:7, 11:12, 16:17)
knitr::kable(m1_mm[first_two,])
```

The coefficient table is

```{r factorial-coef, echo=FALSE}
knitr::kable(m1_coef, digits=c(2,2,1,3, 2, 2), caption="Coefficient table of the factorial model")
```

1. The Intercept ($b_0$) is the mean of the reference (HAC-/Indole-) group, and so the mean of the upper left cell ("Control") in Table \@ref(tab:factorial-coef).
2. The hacHAC+ coefficient ($b_1$) is the estimate of the added HAC effect relative to the reference, and so is the mean of the lower left cell ("HAC") minus the mean of the upper left cell ("Control"). Another way of stating this is, it is **the effect of HAC when Indole is at its reference level**.
3. The indoleIndole+ coefficient ($b_2$) is the estimate of the added Indole effect relative to the reference, and so is the mean of the upper right cell ("Indole") minus the mean of the upper left cell ("Control"). Another way of stating this is, **it is the effect of Indole when HAC is at its reference level**.
4. The hacHAC+:indoleIndole+ coefficient ($b_3$) is the estimate of the **interaction effect**. If we added the HAC effect ($b_1$) and the Indole effect ($b_2$) to the Control mean ($b_0$), we would get the expected mean of the "HAC+Indole" group **if the effects were additive**. The hacHAC+:indoleIndole+ effect ($b_3$) is the additional bit that we need to get from this additive expectation to the modeled HAC+Indole mean (Figure \@ref(factorial-what-are-coefficients-plot)). It is the difference between the mean of the bottom right cell ("HAC+Indole") and the sum of the coefficients of the other three cells ($b0$, $b1$, $b2$).

An interaction is a **non-additive effect**. Think about this. Adding HAC alone increases ABA concentration by 13.3 ng per g FW. Adding Indole alone increases ABA concentration by 8.8 ng per g FW. If these effects were purely additive, then adding both HAC and Indole to the Control mean should result in a mean of 19.2 + 13.3 + 8.8 = 41.3 ng per g FW in the HAC+Indole group. The modeled mean is 54.1 ng per g FW. The difference observed - additive is 54.1 - 41.3 = 12.8 ng per g FW. Compare this to the interaction coefficient in the coefficient table.

```{r factorial-what-are-coefficients-plot, echo=FALSE, fig.cap="Meaning of coefficients in factorial model. b0 (blue line) is the mean of the reference (Control). b1 (orange line) is the /HAC effect. Numerically, it is the mean of the HAC group minus the mean of the reference. b2 (green line) is the Indole effect. Numerically it is the mean of the Indole group minus the mean of the reference. The expected mean of the HAC+Indole group if HAC and Indole were additive is b0 + b1 + b2 (gray circle). b3 (purple line) is the interaction effect. Numerically, it is the observed mean of the HAC+Indole group minus the expected additive mean (gray circle)"}
m1 <- lm(aba ~ hac * indole, data = fig1)
m1_emm <- emmeans(m1, specs=c("hac", "indole"))%>%
  summary() %>%
  data.table()

treatment_levels <- c("Control", "HAC", "Indole", "HAC+Indole")
m1_emm[, treatment := factor(treatment_levels, treatment_levels)]

b <- coef(m1)
b0 <- b[1]
b1 <- b[2]
b2 <- b[3]
b3 <- b[4]


gg_add <- ggplot(data = m1_emm,
                 aes(x = treatment,
                     y = emmean,
                     color = treatment)) +
  geom_point(size = 4, alpha = 0.5) +
  coord_cartesian(ylim = c(0, 60)) +

  geom_point(aes(x = 4,
                 y = b0 + b1 + b2),
             size = 4,
             alpha = 0.5) +
  
  geom_segment(aes(x = c(1, 2, 3, 4),
                   y = c(0,emmean[1],emmean[1],emmean[1]),
                   xend = c(1, 2, 3, 4),
                   yend = emmean),
               size = 1,
               show.legend = FALSE) +
 
  geom_segment(aes(x = c(4),
                   y = c(emmean[1]),
                   xend = c(4),
                   yend = c(emmean[2])),
               size = 1,
               color = pal_ito_seven[2]) +
  geom_segment(aes(x = c(4),
                   y = c(emmean[2]),
                   xend = c(4),
                   yend = c(emmean[2] + (emmean[3]-emmean[1]))),
               size = 1,
               color = pal_ito_seven[3]) +
  
  annotate(geom = "text",
           label="b[0]",
           parse=TRUE,
           x = 1.15,
           y = b0/2) +
  annotate(geom = "text",
           label="b[1]",
           parse=TRUE,
           x = 2.15,
           y = b0 + b1/2) +
  annotate(geom = "text",
           label="b[2]",
           parse=TRUE,
           x = 3.15,
           y = b0 + b2/2) +
  annotate(geom = "text",
           label="b[3]",
           parse=TRUE,
           x = 4.15,
           y = b0 + b1 + b2 + b2/2) +

  annotate(geom = "text",
           label="interaction effect",
           x = 2.55,
           y = 51.5,
           size = 4) +
  geom_segment(aes(x = 3.1,
                   y = 51,
                   xend = 3.9,
                   yend = b0+b1+b2+b3/2),
               arrow=arrow(length = unit(0.05, "npc"),
                           ends="last",type="open"),
               color="black") +

  annotate(geom = "text",
           label="additive expectation",
           x = 2.55,
           y = 44.5,
           size = 4) +
  geom_segment(aes(x = 3.2,
                   y = 44,
                   xend = 3.9,
                   yend = b0+b1+b2+0.3),
               arrow=arrow(length = unit(0.05, "npc"),
                           ends="last",type="open"),
               color="black") +
  
  scale_color_manual(values=pal_ito_seven,
                     name = "Group mean") +
  
  ylab("ABA (ng per g FW)") +
  theme_minimal_hgrid() +
  
  theme(axis.title.x=element_blank()) +
  scale_y_continuous(
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05)))  +

  NULL
  
gg_add
```

### The biological interpretation of an interaction effect

The biological reasons causing interaction effects are highly variable but lets consider how interactions *might* arise in the context of the ABA defense response to HAC and Indole. Additive effects (no interaction) may occur when combined treatments act independently of each other. This might occur in the Maize ABA response if the signaling path from HAC reception to ABA secretion and Indole reception to ABA secretion occur in different cells or by different signaling pathways and activity in either pathway has no influence on the other. Positive, or **synergistic** interaction effects may occur when combined treatments augment each other's ability to affect the response. This could occur in the Maize ABA response if an active signaling path from one of the volatile compound to ABA secretion makes the signaling path from the other compound to ABA secretion more sensitive to that compound. Negative, or **antagonistic** interaction effects may occur when combined treatments interfere with each other's ability to affect the response. This could occur in the Maize ABA response if an active signaling path from one of the volatile compound to ABA secretion inhibits the signaling path from the other compound to ABA secretion. Negative interaction effects could also occur if there is a simple threshold response and all it takes is either the HAC or the Indole signaling pathway to activate the response.

### Conditional and marginal means

```{r factorial-conditional-means, echo=FALSE, message=FALSE}
options(knitr.kable.NA = '')
ycols <- c("group", names(m1_emm))

m1_emm_dt <- emmeans(m1, specs=c("hac", "indole")) %>%
  summary() %>%
  data.table()

m1_emm_hac <- emmeans(m1, specs=c("hac")) %>%
  summary() %>%
  data.table()

m1_emm_indole <- emmeans(m1, specs=c("indole")) %>%
  summary() %>%
  data.table()


hac_0 <- c(m1_emm_dt[hac == "HAC-", emmean],
           m1_emm_hac[hac == "HAC-", emmean])
hac_1 <- c(m1_emm_dt[hac == "HAC+", emmean],
           m1_emm_hac[hac == "HAC+", emmean])
indole_means <- c(m1_emm_indole[, emmean], NA)

means_table <- data.frame("HAC-" = hac_0,
                          "HAC+" = hac_1,
                          "mean" = indole_means)
row.names(means_table) <- c("Indole-", "Indole+","mean")


bgc1 <- pal_okabe_ito[1]
bgc2 <- pal_okabe_ito[2]

knitr::kable(means_table, 
             digits = 3,
             col.names = c("HAC-", "HAC+", "mean"),
             caption = "Conditional (white background) and marginal (color background) means from full factorial model fit to ABA data") %>%
  kable_styling(full_width = FALSE) %>%
  # row_spec(row = 0,
  #          bold = F) %>%
  column_spec(column = 1,
              bold = c(T, T, T)) %>%
  column_spec(column = 4,
              background = c(bgc1, bgc1, "white")) %>%
  column_spec(column = 3,
              background = c("white", "white", bgc2)) %>%
  column_spec(column = 2, 
              background = c("white", "white", bgc2))
 

```

The conditional means from model \@ref(eq:factorial-full) are shown in the upper left $2 \times 2$ block (white background) of Table \@ref(tab:factorial-conditional-means). These means are conditional on the level of $hac$ and $indole$. The values in the last row and column are the **marginal means**, which are the means of the associated row or column cells (these values are in the margins of the table). More generally, *marginal* refers to a statistic averaged across multiple levels of another variable. The marginal means of $indole$ (orange background) are the means of the `Indole+` and `Indole-` rows. The marginal means of $hac$ (blue background) are the means of the `HAC+` and `HAC-` columns.

### Simple (conditional) effects

In a factorial experiment with crossed A and B factors, there is an effect of factor A (relative to the reference, or another level of factor A) for each of the *p* levels of factor B. And, there is an effect of factor B (relative to the reference, or another level of factor B) for each of the *m* levels of factor A.

For the maize defense response experiment, there is an Indole effect at `hac = HAC-` and a different effect at `hac = HAC+`. Similarly, there is a HAC effect at `indole = Indole-` and a different effect at `indole = Indole+`. These effects, or **contrasts** (differences in modeled means), are called the **simple effects**. I prefer **conditional effects**, since the value of the effect is conditional on the level factor of the other factor.

```{r, echo=FALSE}
m1_emm <- emmeans(m1, specs=c("hac", "indole"))
m1_pairs <- contrast(m1_emm,
                        method = "revpairwise",
                        adjust = "none",
                        simple = "each",
                        combine = TRUE)
knitr::kable(m1_pairs, 
             digits=c(1,1,1,1,2,1,1,5),
             caption = "Conditional (or \"simple\") effects of the factorial model.") %>%
  kable_styling()
```

The first two rows are the conditional effects of $hac$ in each of the levels of $Indole$. The last two rows are the conditional effects of $Indole$ in each of the levels of $hac$.

```{r factorial-simple-effects, echo = FALSE}
options(knitr.kable.NA = '')
ycols <- c("group", names(m1_emm))

m1_emm <- emmeans(m1, specs=c("hac", "indole"))
m1_pairs_dt <- contrast(m1_emm,
                        method = "revpairwise",
                        adjust = "none",
                        simple = "each",
                        combine = TRUE) %>%
  summary() %>%
  data.table()

hac_0 <- c(m1_emm_dt[hac == "HAC-", emmean],
           m1_pairs_dt[hac == "HAC-", estimate])
hac_1 <- c(m1_emm_dt[hac == "HAC+", emmean],
           m1_pairs_dt[hac == "HAC+", estimate])
hac_diffs <- c(m1_pairs_dt[1:2, estimate], NA)

simple_table <- data.frame("HAC-" = hac_0,
                          "HAC+" = hac_1,
                          "simple" = hac_diffs)
row.names(simple_table) <- c("Indole-", "Indole+","simple")



bgc1 <- pal_okabe_ito[1]
bgc2 <- pal_okabe_ito[2]

knitr::kable(simple_table, 
             digits = 3,
             col.names = c("HAC-", "HAC+", "simple"),
             caption = "Conditonal (\"simple\") effects of HAC (orange background) and Indole (blue background) on ABA concentration. The conditional means of each combination of the factor levels are in the cells with the white background. The simple effect is the difference in the means of the associated row or column.") %>%
  kable_styling(full_width = FALSE) %>%
  # row_spec(row = 0,
  #          bold = F) %>%
  column_spec(column = 1,
              bold = c(T, T, T)) %>%
  column_spec(column = 4,
              background = c(bgc1, bgc1, "white")) %>%
  column_spec(column = 3,
              background = c("white", "white", bgc2)) %>%
  column_spec(column = 2, 
              background = c("white", "white", bgc2))
 


```

One way to understand conditional effects is by using the $m \times p$ table of treatment combination means (Table \@ref(factorial-simple-effects)). The values in the right-side column (orange) are the conditional effects of HAC at each level of Indole. These values are the difference of the means in the associated row. For example, the conditional effect of $hac$ when `indole = Indole-` is 13.297 (first value in orange column). The values in the bottom row (blue) are the conditional effects of Indole at each level of HAC. These values are the difference of the means in the associated column. For example, the conditional effect of $indole$ when `hac = HAC+` is 21.594 (second value in blue row). Note that the first conditional effect for each factor has a corresponding row in the table of coefficients of the fit model.

### Marginal effects

The average of the conditional effects for a factor are the **marginal effects**, or the **main effects** in ANOVA terminology.

```{r factorial-main, echo=FALSE, warning=FALSE, message=FALSE}

m1_hac_dt <- emmeans(m1, specs = "hac") %>%
  contrast(
    method = "revpairwise") %>%
  summary() %>%
  data.table()

m1_indole_dt <- emmeans(m1, specs = "indole") %>%
  contrast(
    method = "revpairwise") %>%
  summary() %>%
  data.table()

marginal_table <- copy(simple_table)

marginal_table <- rbind(marginal_table, marginal =
                        c(NA, NA, m1_hac_dt[1, estimate]))
marginal_table <- cbind(marginal_table,
                        marginal = c(NA, NA, m1_indole_dt[1, estimate], NA))

orange_color <- pal_okabe_ito[1]
blue_color <- pal_okabe_ito[2]
gray_color <- pal_jco(alpha = 0.6)(9)[3]

knitr::kable(marginal_table, 
             digits = 3,
             col.names = c("HAC-", "HAC+", "simple", "marginal"),
             caption = "Marginal effects of HAC (orange) and Indole (blue) on ABA concentration. Simple effects are in grey cells. The conditional means of each combination of the factor levels are in the white cells.") %>%
  kable_styling(full_width = FALSE) %>%
  # row_spec(row = 0,
  #          bold = F) %>%
  column_spec(column = 1,
              bold = c(T, T, T,T)) %>%
  column_spec(column = 2, 
              background = c("white", "white", gray_color, "white")) %>%
  column_spec(column = 3,
              background = c("white", "white", gray_color, "white")) %>%
  column_spec(column = 4,
              background = c(gray_color, gray_color, "white", orange_color)) %>%
  column_spec(column = 5,
              background = c("white", "white", blue_color, "white"))

```

<div style="background-color:#cccccc; text-align:left; vertical-align: middle; padding:20px 47px;">
Be careful with reporting marginal effects. In this example, the simple effects of HAC are very different for the `Indole-` and `Indole+` treatment levels and the mean of these two effects may not be especially relevant to the question that we are pursuing. If the simple effects of a factor are similar, then it may make more sense to report the marginal effect.
</div> 

### The additive model

Marginal effects can be useful for summarizing a general trend, but, like any average, might not be especially meaningful if there is large heterogeneity of the simple effects, which occurs when the interaction effect is large. The maize ABA response is a good example of marginal effects that would be highly misleading to present without further comment.

If an interaction effect is small, then it can be useful to estimate the effects of the two factors as if the interaction were equal to zero.

\begin{equation}
aba = \beta_0 + \beta_1 hac_{HAC^+} + \beta_2 indole_{Indole^+} + \varepsilon
(\#eq:factorial-reduced)
\end{equation}

This is a **reduced model** because one of the terms has been removed from the model. This particular reduced model is often referred to as the **additive model**, since it excludes the interaction term, which is a *product* of other terms. In R, this model is

```{r}
m2 <- lm(aba ~ hac + indole, data = fig1)
```

The model coefficients of the additive model are

```{r factorial-reduced-model, echo=FALSE}
m2_coef <- cbind(coef(summary(m2)),
        confint(m2))
knitr::kable(m2_coef, 
             digits=c(2,2,1,3),
             caption = "Model coefficients of additive model.") %>%
  kable_styling()

```

The conditional effects of the reduced model are

```{r, echo=FALSE}
m2_emm <- emmeans(m2, specs=c("hac", "indole"))
m2_pairs <- contrast(m2_emm,
                 method = "revpairwise",
                 adjust = "none",
                 simple = "each",
                 combine = TRUE) %>%
  summary(infer = TRUE)


knitr::kable(m2_pairs,
             digits = c(1,1,1,5,2,1,2,2,2,5),
             caption = "Conditional effects of additive model.") %>%
  kable_styling()

```

The table shows that, in an additive model, all conditional effects for one factor are the same for each level of the other factor. This makes sense. If the model fit is additive, the interaction effect is set to zero by the model and there cannot be differences in conditional effects among the contrasts at each of the levels of the other factor (otherwise, there would be an interaction). Also note that the conditional effects xxx. Probably a better way of thinking about this is, it doesn't make sense to compute or discuss conditional effects in an additive model. Instead, an additive model automatically computes marginal effects.

Compare the table of marginal effects of the additive model to the table of marginal effects of the full model. The estimates are the same but the *t*-values and *p*-values differ because of different degrees of freedom (the full model estimates one more parameter, the interaction effect). The estimate is the same only if the design is balanced, which means that each combination of treatment levels has the same sample size *n*.

### Reduce models for the right reason

Unless one factor truly has no effect, there will always be an interaction. As stated above, interactions are ubiquitous. If an interaction is small, it can make sense to drop the interaction term and re-fit an additive model to estimate marginal effects in order to present a simplified picture of what is going on, with the recognition that these estimates are smoothing over the heterogenity in conditional (simple) effects that truly exist.

Aided and abetted by statistics textbooks for biologists, there is a long history of researchers dropping an interaction effect because the interaction $p>0.05$. Don't do this. It doesn't make any sense.

1. The $p$-value is an arbitrary dichotomization of a continuous variable. Would it make sense to behave differently if the interaction were $p=0.051$ vs. $p=0.049$, given that these two p-values are effectively identical?
2. A $p$-value is not evidence that an effect is zero, or "doesn't exist", or even that an effect is "trivially small". This is because $p$-values are a function of measurement error, sampling error, and sample size, in addition to effect size.

## Working in R
### Plotting linear models with crossed factors
#### Response plot -- Sample means and error bars using ggpubr

```{r}
compare_list <- list(c("Control", "HAC"),
                     c("HAC+Indole", "Indole"),
                     c("Control", "Indole"),
                     c("HAC+Indole", "HAC"),
                     c("HAC+Indole", "Control"))
gg1 <- ggstripchart(data = fig1,
                    x = "treat",
                    y = "aba",
                    color = "hac",
                    shape = "indole",
                    add = "mean_ci",
                    ylab = "Abcisic acid (ng per g FW)",
                    palette = pal_ito_seven) +
  
  stat_compare_means(method = "t.test",
                     comparisons=compare_list)

gg1
```

```{r}
gg2 <- gg1 +
  annotate(geom = "text",
           label = c("-", "+", "-", "+"),
           x = 1:4,
           y = 10
  ) +
  annotate(geom = "text",
           label = c("HAC:"),
           x = 0.75,
           y = 10
  ) +
  annotate(geom = "text",
           label = c("-", "-", "+", "+"),
           x = 1:4,
           y = 5
  ) +
  annotate(geom = "text",
           label = c("Indole:"),
           x = 0.75,
           y = 5
  ) +

    NULL
gg2
```

